"use strict";angular.module("prevuApp",["ngCookies","ngResource","ngSanitize","ngRoute","ui.bootstrap","ui.select","nvd3ChartDirectives"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/auteur",{templateUrl:"views/auteur.html",controller:"AuteurCtrl",reloadOnSearch:!1}).when("/livre",{templateUrl:"views/issues.html",controller:"IssuesCtrl",reloadOnSearch:!1}).when("/experiment",{templateUrl:"views/experiment.html",controller:"ExperimentCtrl",reloadOnSearch:!1}).otherwise({redirectTo:"/"})}]),angular.module("prevuApp").controller("MainCtrl",["$scope","$filter","prevuAPIservice",function(a,b,c){a.listUfr={AESECOGES:"UFR AES, ÉCONOMIE ET GESTION",ARTS:"UFR ARTS, PHILOSOHIE, ESTHÉTIQUE",CC:"UFR CULTURE ET COMMUNICATION",DROIT:"UFR DROIT","ED 031":"ED PRATIQUES ET THÉORIES DU SENS","ED 159":"ED ESTHÉTIQUE, SC. ET TECHNO. DES ARTS","ED 224":"ED COGNITION, LANGAGE, INTERACTION","ED 401":"ED SCIENCES SOCIALES","Form. perm":"FORMATION PERMANENTE",IED:"INSTITUT D'ENSEIGNEMENT À DISTANCE",IEE:"INSTITUT D'ETUDES EUROPÉENNES",IFG:"INSTITUT FRANÇAIS DE GÉOPOLITIQUE",IPT:"INFORMATIQUE POUR TOUS","IUT MONTR":"IUT DE MONTREUIL","IUT TREMBL":"IUT DE TREMBLAY-EN-FRANCE","LLCE-LEA":"UFR LLCE-LEA",MITSIC:"UFR M.I.T.S.I.C",PSYCHO:"UFR DE PSYCHOLOGIE",SDL:"UFR SCIENCES DU LANGAGE",SEPF:"UFR SCIENCES ÉDUCATION, PSYCHANALYSE,FLE",SUFICE:"SUFICE","T&S":"UFR TEXTES ET SOCIÉTÉS.",TES:"UFR TERRITOIRES, ENVIRONNEMENTS,SOCIÉTÉS"},c.getTopBooks().success(function(b){var d=1;angular.forEach(b.books,function(a){a.top=d,c.getCoverBook(a.biblionumber).success(function(b){a.TinyImage=b.TinyImage,a.LargeImage=b.LargeImage,a.MediumImage=b.MediumImage,a.Edito=b.Edito}),d++}),a.topBooks=b.books;var e=new Miso.Dataset({data:b.books});e.fetch({success:function(){a.stats={docs:this.length,issues:this.sum("issues"),issuesMax:this.max("issues"),issuesMin:this.min("issues"),renewals:this.sum("renewals"),male:this.sum("Male"),female:this.sum("Female"),years:this.mean("publicationyear").toFixed(2),pays:this.countBy("pays").toJSON(),langue:this.countBy("langue").toJSON(),ccode:this.countBy("ccode").toJSON()}}})}),c.getStatsIssuesAllByMonth().success(function(b){a.statsIssuesAllByMonth=[{key:"Prêts",area:!0,values:b.stats}]}),c.getTopIssuesByUfr("DROIT").success(function(){}),c.getStatsMain().success(function(b){function c(a,b){for(var c=0,d=a.length;d>c;c+=1)if(a[c].key===b)return a[c]}a.books_count_graph=[{key:"books_count_graph",area:!0,values:b[0].books_count_graph}],a.issues_count_graph=[{key:"issues_count_graph",area:!0,values:b[0].issues_count_graph}],a.borrowers_count_graph=[{key:"borrowers_count_graph",area:!0,values:b[0].borrowers_count_graph}],a.borrowers_sex=b[0].borrowers_sex,a.borrowers_age=b[0].borrowers_age,a.issues_categoryCode=b[0].issues_categoryCode,a.issues_UfrRepartition=[{key:"Ufr",values:b[0].issues_UfrRepartition.slice(0,15)}],a.semestres=[{name:"Semestre 2 - 2012",id:"Semestre2012"},{name:"Semestre 1 - 2013",id:"Semestre2012-2013_1"},{name:"Semestre 2 - 2013",id:"Semestre2012-2013_2"},{name:"Semestre 1 - 2014",id:"Semestre2013-2014"}],a.selectedSemestre=a.semestres[1],a.issues_niveau_light=b[0].issues_niveau_light[a.semestres[1].id],a.setSemestre_issues_niveau_light=function(c){a.issues_niveau_light=b[0].issues_niveau_light[c.id]},a.ByUfr_books=b[0].ByUfr.books,a.ByUfr_ccode=b[0].ByUfr.ccode;var d=new Array;angular.forEach(b[0].ByUfr.books,function(b){d.push({name:a.listUfr[b.key]?a.listUfr[b.key]:b.key,key:b.key})}),a.ufrKeys=d,a.selectedUFR={},a.selectedUFR.selected=a.ufrKeys[1],a.ByUfr_ccode=[{key:a.ufrKeys[1].key,values:b[0].ByUfr.ccode[a.ufrKeys[1].key].values.slice(0,10)}],console.log(a.ByUfr_ccode),a.ByUfr_books=b[0].ByUfr.books[a.ufrKeys[1].key],a.issues_ufrOnlyUfr=[c(b[0].issues_ufr,a.ufrKeys[1].key)],a.ByUfr_borrowers_sex=b[0].ByUfr.borrowers_sex[a.ufrKeys[1].key].values,a.ByUfr_borrowers_age=b[0].ByUfr.borrowers_age[a.ufrKeys[1].key],a.ByUfr_issues_numbers=b[0].ByUfr.issues_numbers[a.ufrKeys[1].key],a.ByUfr_borrowers_numbers=b[0].ByUfr.borrowers_numbers[a.ufrKeys[1].key],a.setUfr=function(d){a.ByUfr_books=b[0].ByUfr.books[d.key],a.ByUfr_ccode=[{key:d.key,values:b[0].ByUfr.ccode[d.key].values.slice(0,10)}],a.issues_ufrOnlyUfr=[c(b[0].issues_ufr,d.key)],a.ByUfr_borrowers_sex=b[0].ByUfr.borrowers_sex[d.key].values,a.ByUfr_borrowers_age=b[0].ByUfr.borrowers_age[d.key],a.ByUfr_issues_numbers=b[0].ByUfr.issues_numbers[d.key],a.ByUfr_borrowers_numbers=b[0].ByUfr.borrowers_numbers[d.key]}})}]),angular.module("prevuApp").filter("objectByKeyValFilter",function(){return function(a,b,c){var d={};return angular.forEach(a,function(a,e){a[b]&&a[b]==c&&(d[e]=a)}),d}}),angular.module("prevuApp").controller("AuteurCtrl",["$scope","$routeParams","$location","$http","Books","prevuAPIservice",function(a,b,c,d,e,f){var g=function(b){var c=new Miso.Dataset({data:b});c.fetch({success:function(){a.stats={docs:this.length,issues:this.sum("issues"),issuesMax:this.max("issues"),issuesMin:this.min("issues"),renewals:this.sum("renewals"),male:this.sum("Male"),female:this.sum("Female"),years:this.mean("publicationyear").toFixed(2),pays:this.countBy("pays").toJSON(),langue:this.countBy("langue").toJSON()},a.sexPie=[{sex:"Femme",count:a.stats.female},{sex:"Homme",count:a.stats.male}]}})},h=function(b){a.info=b,f.getBookByAuthor(b).success(function(b){console.log(j(b.search)),a.books=b.search,g(b.search),console.log(b.search)})},i=[],j=function(b){a.booksCovers=[],angular.forEach(b,function(b){f.getCoverBookAmazon(b.biblionumber).success(function(c){a.booksCovers.push({biblionumber:b.biblionumber,item:b,cover:c}),console.log(i)}),console.log(i)}),console.log(a.booksCovers)};a.search=function(){h(a.queryTerm),c.search("nom",a.queryTerm.author_nom),c.search("prenom",a.queryTerm.author_prenom)},a.suggestAuthors=function(a){return d.get("http://tactiques.org/prevu/application/api/author/search/"+a).then(function(a){var b=[];return angular.forEach(a.data.search,function(a){b.push(a)}),b})};var k=c.search();k.nom&&h({author_nom:k.nom,author_prenom:k.prenom})}]),angular.module("prevuApp").factory("Books",["$resource",function(a){return a("http://localhost:8888/prevu/application/api/search/:auteurName",{auteurName:"@auteurName"},{loan:{method:"PUT",params:{bookId:"@bookId"},isArray:!1}})}]),angular.module("prevuApp").directive("stupidTable",function(){return{restrict:"A",link:function(a,b){b.stupidtable(),b.on("aftertablesort",function(a,b){var c=$(this).find("th");c.find(".arrow").remove();var d=$.fn.stupidtable.dir,e=b.direction===d.ASC?"&uarr;":"&darr;";c.eq(b.column).append('<span class="arrow">'+e+"</span>")})}}}),angular.module("prevuApp").factory("prevuAPIservice",["$http",function(a){var b={},c="http://tactiques.org/prevu/application/";return b.getBookByBiblionumber=function(b){return a({url:c+"api//book/"+b})},b.searchAuthor=function(b){return a({url:c+"api/author/search/"+b})},b.searchBook=function(b){return a({url:c+"api/book/search/"+b})},b.searchBookByAuthor=function(b){return a({url:c+"api/books/author/search/"+b})},b.getBookByAuthor=function(b){return a({method:"POST",url:c+"api/books/author",headers:{"Content-Type":"application/json"},data:b})},b.searchIssuesByTitle=function(b){return a({url:c+"api/issues/title/"+b})},b.searchIssuesByBiblionumber=function(b){return a({url:c+"api/issues/biblionumber/"+b})},b.getAverageByBiblionumber=function(b){return a({url:c+"api/issues/biblionumber/"+b+"/averageAge"})},b.getTopBooks=function(){return a({url:c+"api/books/top/"})},b.getCoverBookAmazon=function(b){return a({url:c+"api/amazon/getCover.php?biblionumber="+b})},b.getCoverBook=function(b){return a({url:c+"api/book/cover/"+b})},b.getStatsIssuesAllByMonth=function(){return a({url:c+"api/stats/issues/years/month"})},b.getStatsIssuesAllByDay=function(){return a({url:c+"api/stats/issues/years/day"})},b.getStatsIssuesAllByMonthAverageNiveau=function(){return a({url:c+"api/stats/issues/years/month/niveau"})},b.getStatsIssuesAllByDayAverageNiveau=function(){return a({url:c+"api/stats/issues/years/day/niveau"})},b.getTopIssuesByUfr=function(b){return a({url:c+"api/stats/issues/ufr/"+b})},b.getStatsMain=function(){return a({url:c+"api/statsJson/stats.json"})},b}]),angular.module("prevuApp").controller("IssuesCtrl",["$scope","$routeParams","$location","$http","prevuAPIservice",function(a,b,c,d,e){var f=function(b){var c=new Miso.Dataset({data:b});c.fetch({success:function(){a.stats={issues:this.length,renewals:this.sum("renewals"),sex:this.countBy("sex").toJSON(),ufr:this.countBy("Ufr").toJSON(),niveau:this.countBy("Niveau").toJSON(),etape:this.countBy("Etape").toJSON(),description:this.countBy("categorycode").toJSON()},a.statsIssueUfr=[{key:"Ufr",values:a.stats.ufr}],a.statsIssueNiveau=[{key:"Niveau",values:a.stats.niveau}]}})},g=function(b){e.searchIssuesByBiblionumber(b).success(function(d){a.issues=d,f(d),c.search("biblionumber",b)}),e.getCoverBookAmazon(b).success(function(b){a.covers=b}),e.getAverageByBiblionumber(b).success(function(b){a.averageAge=b[0].averageAge})},h=function(b){e.getBookByBiblionumber(b).success(function(b){a.info=b})};a.suggestBooks=function(a){return d.get("http://tactiques.org/prevu/application/api/book/search/"+a).then(function(a){var b=[];return angular.forEach(a.data.search,function(a){b.push(a)}),b})},a.search=function(){g(a.queryTerm.biblionumber),h(a.queryTerm.biblionumber)};var i=c.search();i.biblionumber&&(g(i.biblionumber),h(i.biblionumber))}]),angular.module("prevuApp").controller("HeadernavCtrl",["$scope","$location",function(a,b){a.isActive=function(a){return a===b.path()}}]),angular.module("prevuApp").directive("visTimeline",function(){return{template:"<div></div>",restrict:"A",scope:{value:"=value"},link:function(a){a.$watch("value",function(a){if(a){for(var b=function(a,b){for(var c=[],d=0;d<a.length;d++){var e=a[d][b];-1===c.indexOf(e)&&c.push(e)}return c},c=b(a,"itemnumber"),d=new vis.DataSet,e=0;e<c.length;e++)d.add({id:c[e],content:"Ex. #"+(e+1)});console.log(d);var f=new vis.DataSet,g=0,h=document.getElementById("visualization");angular.forEach(a,function(a){f.add({id:g++,content:a.Niveau,niveau:a.Niveau,sex:a.sex,start:new Date(a.issuedate),startDate:a.issuedate,end:new Date(a.returndate),endDate:a.returndate,ufr:a.Ufr,className:a.Niveau,group:a.itemnumber})});var i={stack:!1,margin:{item:0,axis:5},min:new Date(2011,12,1),max:new Date(2014,6,1),orientation:"top",align:"center",zoomMin:5184e5},j=new vis.Timeline(h);j.setOptions(i),j.setGroups(d),j.setItems(f),j.on("select",function(a){console.log(a.items[0]),console.log(f.data[a.items[0]]),$(".itemInfos .niveau").html("<strong>Niveau : </strong>"+f.data[a.items[0]].niveau),$(".itemInfos .sex").html("<strong>Sex : </strong>"+f.data[a.items[0]].sex),$(".itemInfos .ufr").html("<strong>Ufr : </strong>"+f.data[a.items[0]].ufr),$(".itemInfos .dateStart").html("<strong>Date de début : </strong>"+f.data[a.items[0]].startDate),$(".itemInfos .dateEnd").html("<strong>Date de fin : </strong>"+f.data[a.items[0]].endDate)})}})}}}),angular.module("prevuApp").filter("groupBy",function(){return function(a,b){if(a){for(var c,d=[],e=0;e<a.length;e++)c||(c=[]),c.push(a[e]),(e+1)%b===0&&(d.push(c),c=null);return c&&d.push(c),d}}}),angular.module("prevuApp").controller("DiscretebarchartCtrl",["$scope",function(a){var b=["#2790b0","#79b5ac"];a.colorFunction=function(){return function(a,c){return b[c]}},a.xFunction=function(){return function(a){return a.month+"/"+a.year}},a.yFunction=function(){return function(a){return d3.round(a.issues)}},a.xFunctionUfr=function(){return function(a){return a.Ufr}},a.yFunctionUfr=function(){return function(a){return d3.round(a.count)}},a.xFunctionIssues=function(){return function(a){return parseInt(a.issuesdate)}},a.yFunctionIssues=function(){return function(a){return parseInt(a.issues)}},a.xFunctionNiveau=function(){return function(a){return a.ccode}},a.yFunctionNiveau=function(){return function(a){return d3.round(a.count)}},a.xAxisTickFormatFunction=function(){return function(a){return d3.time.format("%b-%y")(new Date(1e3*a))}},a.toolTipContentFunction=function(){return function(a,b,c,d){return"<h3>"+d.point.issues+" prêts</h3><span>"+d3.time.format("%B-%y")(new Date(1e3*d.point.issuesdate))+"</span>"}},a.format=function(){return function(a){var b=d3.format("r0");return b(a)}},a.render=function(){console.log("render:")},a.$on("renderEnd.directive",function(a,b){console.log(b)}),a.$on("$viewContentLoaded",function(){console.log("render")})}]),angular.module("prevuApp").directive("spinLoader",function(){return{restrict:"E",transclude:!0,template:'<span class="{{ loading }}"></span><div ng-transclude ></div>'}}),angular.module("prevuApp").directive("onFinishRender",["$timeout",function(){return{restrict:"A",link:function(a,b,c){a.$last===!0&&a.$evalAsync(c.onFinishRender)}}}]),angular.module("prevuApp").controller("LinechartCtrl",["$scope",function(a){var b=["#2790b0","#79b5ac"];a.colorFunction=function(){return function(a,c){return b[c]}},a.xFunction=function(){return function(a){return a.id}},a.yFunction=function(){return function(a){return a.value}},a.xFunctionUFR=function(){return function(a){return a.issuesdate}},a.yFunctionUFR=function(){return function(a){return a.issues}},a.xAxisTickFormatFunction=function(){return function(a){return d3.time.format("%d-%b-%y")(new Date(1e3*a))}},a.toolTipContentFunction=function(){return function(a,b,c,d){return"<h3>"+d.point.name+"</h3><span>"+d.point.value+"</span>"}},a.toolTipContentFunctionUFR=function(){return function(a,b,c,d){return"<h3>"+d.point.Ufr+"</h3>"+d.point.issues+" "+d3.time.format("%b-%y")(new Date(1e3*d.point.issuesdate))}},a.yAxisTickFormatFunction=function(){return function(a){return d3.format(",d")(a)}}}]),angular.module("prevuApp").controller("LinefocuschartCtrl",["$scope",function(a){a.xFunction=function(){return function(a){return a.timestamp}},a.yFunction=function(){return function(a){return a.issues}},a.xAxisTickFormatFunction=function(){return function(a){return d3.time.format("%d-%b-%y")(new Date(1e3*a))}},a.toolTipContentFunction=function(){return function(a){return"Super New Tooltip<h1>"+a+"</h1>"}},a.yAxisTickFormatFunction=function(){return function(a){return d3.format(",d")(a)}}}]),angular.module("prevuApp").controller("PiechartCtrl",["$scope",function(a){var b=["#2790b0","#c75233"],c=["#8dd3c7","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"];a.color_schem=function(){return function(a,c){return b[c]}},a.color_viz=function(){return function(a,b){return c[b]}},a.xFunction=function(){return function(a){return a.sex}},a.xFunctionLabel=function(){return function(a){return a.label}},a.yFunctionBorrowersUfr=function(){return function(a){return a.value}},a.yFunction=function(){return function(a){return a.count}}}]),angular.module("prevuApp").controller("PiechartlangueCtrl",["$scope",function(a){a.xFunction=function(){return function(a){return a.langue}},a.yFunction=function(){return function(a){return a.count}}}]),angular.module("prevuApp").controller("PiechartpaysCtrl",["$scope",function(a){a.xFunction=function(){return function(a){return a.pays}},a.yFunction=function(){return function(a){return a.count}}}]),angular.module("prevuApp").controller("MultibarhorizchartCtrl",["$scope",function(a){a.categoryBook={Y:"Histoire",E:"Sociologie",C:"Psychologie",VF:"Français",G:"Economie Stats",SA:"Arts plastiques",K:"Sciences éducation",B:"Philosophie",Z:"Fonds RDA",H:"Droit Admin",F:"Sciences politiques",W:"Linguistique",SC:"Cinéma",VA:"Anglais",FJD:"Fonds Jean Dresch",A:"Info Doc Médias",U:"Usuels Généralités",X:"Géographie",M:"Ethnologie",SP:"Photographie",ST:"Arts du spectacle",SM:"Musique",VL:"Littérature générale",L:"Sciences",VE:"Espagnol",VD:"Allemand",D:"Religion",N:"Informatique Tech",T:"Urbanisme",VR:"Langues slaves",VS:"Arabe Hébreu",VI:"Italien",VP:"Portugais",FEL:"Fonds Ernest Labrousse",VC:"Langues Asie",VG:"Latin Grec",FME:"Fonds Maghreb Europe",MAM:"Fonds M. A. Macciocchi",VM:"D'autres langues et littératures",CER:"Fonds CERASA",BD:"Bandes dessinées",YC:"Concours Histoire",CS:"Fonds Claude Simon",XC:"Concours Géographie"},a.listUfr={AESECOGES:"UFR AES, ÉCONOMIE ET GESTION",ARTS:"UFR ARTS, PHILOSOHIE, ESTHÉTIQUE",CC:"UFR CULTURE ET COMMUNICATION",ZZ:"ZZ",DROIT:"UFR DROIT","ED 031":"ED PRATIQUES ET THÉORIES DU SENS","ED 159":"ED ESTHÉTIQUE, SC. ET TECHNO. DES ARTS","ED 224":"ED COGNITION, LANGAGE, INTERACTION","ED 401":"ED SCIENCES SOCIALES","Form. perm":"FORMATION PERMANENTE",IED:"INSTITUT D'ENSEIGNEMENT À DISTANCE",IEE:"INSTITUT D'ETUDES EUROPÉENNES",IFG:"INSTITUT FRANÇAIS DE GÉOPOLITIQUE",IPT:"INFORMATIQUE POUR TOUS","IUT MONTR":"IUT DE MONTREUIL","IUT TREMBL":"IUT DE TREMBLAY-EN-FRANCE","LLCE-LEA":"UFR LLCE-LEA",MITSIC:"UFR M.I.T.S.I.C",PSYCHO:"UFR DE PSYCHOLOGIE",SDL:"UFR SCIENCES DU LANGAGE",SEPF:"UFR SCIENCES ÉDUCATION, PSYCHANALYSE,FLE",SUFICE:"SUFICE","T&S":"UFR TEXTES ET SOCIÉTÉS.",TES:"UFR TERRITOIRES, ENVIRONNEMENTS,SOCIÉTÉS"};var b=["#2790b0","#c75233"];a.color_schem=function(){return function(a,c){return b[c]}},a.xFunction=function(){return function(b){return a.categoryBook[b.label]}},a.xFunctionUfr=function(){return function(b){return a.listUfr[b.label]?a.listUfr[b.label]:b.label}},a.yFunction=function(){return function(a){return d3.round(a.value)}},a.yAxisTickFormatFunction=function(){return function(a){return a.ufr}}}]),angular.module("prevuApp").controller("StackedareachartCtrl",["$scope",function(a){var b=["#8dd3c7","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"];a.color_viz=function(){return function(a,c){return b[c]}},a.xFunction=function(){return function(a){return a.issuesdate}},a.yFunction=function(){return function(a){return a.issues}},a.xAxisTickFormatFunction=function(){return function(a){return d3.time.format("%b-%y")(new Date(1e3*a))}},a.toolTipContentFunction=function(){return function(a){return"Super New Tooltip<h1>"+a+"</h1>"}},a.yAxisTickFormatFunction=function(){return function(a){return a}}}]),angular.module("prevuApp").controller("ExperimentCtrl",["$scope","prevuAPIservice",function(a,b){b.getStatsMain().success(function(b){a.issues_ufr=b[0].issues_ufr,a.issues_niveau=b[0].issues_niveau}),b.getStatsIssuesAllByDay().success(function(b){a.statsIssuesAllByDay=[{key:"Prêts",values:b.stats}]})}]);